<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø¹ - ØµÙ Ø«Ø§Ù„Ø« (v3.3 Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ©)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#0ea5e9; --bg2:#22c55e; --bg3:#a855f7; --gold:#fbbf24; --ink:#0f172a; }
    html,body{height:100%}
    body{font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
    .text-ink{ color: var(--ink) !important; }
    .bg-ink{ background-color: var(--ink) !important; }
    .bg-animated{ position: fixed; inset:0; overflow:hidden; z-index:-1;
      background: radial-gradient(1200px 800px at 120% -10%, rgba(255,255,255,0.08), transparent 60%),
                  radial-gradient(1000px 700px at -20% 120%, rgba(255,255,255,0.08), transparent 60%),
                  linear-gradient(135deg, #0ea5e9 0%, #22c55e 50%, #a855f7 100%); }
    .bubble{position:absolute; border-radius:9999px; filter: blur(8px); opacity:.25; mix-blend: screen; animation: float 18s ease-in-out infinite;}
    .bubble:nth-child(1){ width:360px;height:360px; left:-60px; top:10%; background:#22d3ee; animation-duration:22s;}
    .bubble:nth-child(2){ width:280px;height:280px; right:5%; top:20%; background:#f472b6; animation-duration:18s; animation-delay:2s;}
    .bubble:nth-child(3){ width:420px;height:420px; right:35%; bottom:-80px; background:#fde68a; animation-duration:26s; animation-delay:1s;}
    @keyframes float{ 0%,100%{ transform: translateY(0) translateX(0) rotate(0deg);} 50%{ transform: translateY(-30px) translateX(10px) rotate(2deg);} }
    .confetti{position:fixed; inset:0; pointer-events:none}
    .confetti .p{ position:absolute; width:10px; height:16px; opacity:.9; border-radius:3px; animation: fall linear forwards; }
    @keyframes fall{ 0%{ transform: translateY(-120vh) rotate(0deg);} 100%{ transform: translateY(120vh) rotate(720deg);} }
    @media print{ body{background:white} #app, .confetti, .bg-animated{display:none !important} #certificate{display:block !important} footer{display:none !important} }
  </style>
</head>
<body class="min-h-screen text-white selection:bg-amber-300 selection:text-ink">
  <div class="bg-animated">
    <span class="bubble"></span><span class="bubble"></span><span class="bubble"></span>
  </div>

  <main id="app" class="relative mx-auto max-w-4xl p-6 md:p-10">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-4">
        <img src="https://d.top4top.io/p_35209x7gh1.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù„ØªÙ‚Ù‰"
             class="h-16 w-16 md:h-20 md:w-20 rounded-2xl bg-white/20 backdrop-blur object-contain p-1 shadow-lg"/>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold drop-shadow-sm">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø¹ Ù„Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</h1>
          <p class="text-white/90 text-sm md:text-base">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŒ Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ 10 Ø£Ø³Ø¦Ù„Ø©ØŒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²!</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="bg-white/15 backdrop-blur rounded-2xl px-4 py-2 flex items-center gap-3 shadow">
          <span class="text-sm">Ø§Ù„Ù†Ø¬ÙˆÙ…</span>
          <div id="stars" class="flex gap-1"></div>
        </div>
        <div class="bg-white/15 backdrop-blur rounded-2xl px-4 py-2 flex items-center gap-3 shadow">
          <span class="text-sm">Ø§Ù„Ø³Ø¤Ø§Ù„</span>
          <div class="w-36">
            <div class="h-2 bg-white/20 rounded-full overflow-hidden">
              <div id="progressBar" class="h-2 bg-amber-300" style="width:0%"></div>
            </div>
            <div class="text-xs mt-1"><span id="qIndex">0</span> / <span id="qTotal">10</span></div>
          </div>
        </div>
      </div>
    </header>

    <section class="mb-4">
      <div class="flex flex-wrap items-center gap-2">
        <button id="lvl1" class="px-4 py-2 rounded-2xl bg-emerald-400 hover:bg-emerald-500 text-ink font-extrabold shadow">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: Ø±Ù‚Ù… + Ø±Ù‚Ù…</button>
        <button id="lvl2" class="px-4 py-2 rounded-2xl bg-sky-400 hover:bg-sky-500 text-ink font-extrabold shadow opacity-90">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: (Ø¹Ø¯Ø¯ÙŠÙ† Ù…Ù† Ø®Ø§Ù†ØªÙŠÙ†)</button>
        <span class="text-sm bg-white/20 px-3 py-1 rounded-full">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡</span>
      </div>
    </section>

    <section class="rounded-3xl bg-white/15 backdrop-blur-xl p-5 md:p-8 shadow-2xl border border-white/10">
      <div class="flex flex-col md:flex-row items-stretch gap-6">
        <div class="flex-1">
          <div class="rounded-2xl bg-white/20 p-5 md:p-7 border border-white/10">
            <div class="flex items-center justify-between mb-3">
              <span id="qLabel" class="text-sm md:text-base bg-white/20 px-3 py-1 rounded-full">Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</span>
              <span id="timer" class="text-sm md:text-base bg-amber-300/90 text-ink font-semibold px-3 py-1 rounded-full">â±ï¸ 60 Ø«Ø§Ù†ÙŠØ©</span>
            </div>

            <!-- Ù…Ø³ØªÙˆÙ‰ 1 -->
            <div id="l1wrap" class="flex items-center justify-center gap-3 md:gap-6 py-4 md:py-6">
              <div id="numA" class="w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-gradient-to-br from-amber-300 to-amber-400 text-ink font-extrabold text-3xl md:text-4xl flex items-center justify-center shadow-inner"></div>
              <div class="text-3xl md:text-4xl font-extrabold">+</div>
              <div id="numB" class="w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-gradient-to-br from-sky-300 to-sky-400 text-ink font-extrabold text-3xl md:text-4xl flex items-center justify-center shadow-inner"></div>
              <div class="text-3xl md:text-4xl font-extrabold">=</div>
            </div>

            <!-- Ù…Ø³ØªÙˆÙ‰ 2 -->
            <div id="l2wrap" class="hidden items-center justify-center gap-3 md:gap-5 py-4 md:py-6">
              <div id="A" class="w-24 h-24 md:w-28 md:h-28 rounded-2xl bg-gradient-to-br from-amber-300 to-amber-400 text-ink font-extrabold text-3xl md:text-4xl flex items-center justify-center shadow-inner"></div>
              <div class="text-3xl md:text-4xl font-extrabold">+</div>
              <div id="B" class="w-24 h-24 md:w-28 md:h-28 rounded-2xl bg-gradient-to-br from-rose-300 to-rose-400 text-ink font-extrabold text-3xl md:text-4xl flex items-center justify-center shadow-inner"></div>
              <div class="text-3xl md:text-4xl font-extrabold">=</div>
            </div>

            <!-- Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ©: Ø§Ù„Ø¢Ø­Ø§Ø¯ ÙŠÙ…ÙŠÙ†ØŒ Ø§Ù„Ø¹Ø´Ø±Ø§Øª ÙŠØ³Ø§Ø± -->
            <div id="verticalPanel" class="hidden mt-2 rounded-2xl bg-white/10 border border-white/10 p-4">
              <div class="flex items-center justify-between">
                <div class="font-bold text-white">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ©</div>
                <button id="closeVertical" class="px-3 py-1 rounded-xl bg-rose-400 hover:bg-rose-500 text-ink font-bold">Ø¥Ø®ÙØ§Ø¡</button>
              </div>

              <!-- Ù„Ø§Ø­Ø¸ÙŠ: ÙˆØ¶Ø¹Ù†Ø§ Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø¢Ø­Ø§Ø¯" Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ DOM Ù„Ø£Ù† Ø§Ù„Ù€ RTL ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¸Ù‡Ø± ÙŠÙ…ÙŠÙ†Ù‹Ø§ -->
              <div class="mt-3 grid grid-cols-3 md:grid-cols-5 gap-4 items-start">
                <div></div>

                <!-- Ø§Ù„Ø¢Ø­Ø§Ø¯ (ÙŠÙ…ÙŠÙ†) -->
                <div class="col-span-1 text-center">
                  <div class="text-xs text-white/80">Ø§Ù„Ø¢Ø­Ø§Ø¯</div>
                  <div id="onesCol" class="min-h-[4rem] text-3xl md:text-4xl font-extrabold"></div>
                </div>

                <!-- Ø§Ù„Ø¹Ø´Ø±Ø§Øª (ÙŠØ³Ø§Ø±) -->
                <div class="col-span-1 text-center">
                  <div class="text-xs text-white/80">Ø§Ù„Ø¹Ø´Ø±Ø§Øª</div>
                  <div id="tensCol" class="min-h-[4rem] text-3xl md:text-4xl font-extrabold"></div>
                </div>

                <div class="col-span-1"></div>

                <div class="col-span-3 md:col-span-5">
                  <div class="mt-2 rounded-xl bg-white/5 p-3 text-sm leading-7" id="verticalSteps"></div>
                </div>
              </div>
            </div>

            <div id="choices" class="grid grid-cols-2 gap-3 md:gap-4 mt-2"></div>
            <div id="feedback" class="min-h-10 text-center text-lg font-semibold mt-2"></div>

            <div class="flex flex-wrap items-center justify-center gap-3 mt-2">
              <button id="hintBtn" class="px-5 py-3 rounded-2xl bg-purple-400 hover:bg-purple-500 active:scale-95 transition text-ink font-extrabold shadow-lg">ØªÙ„Ù…ÙŠØ­ ğŸ’¡</button>
              <button id="verticalBtn" class="px-5 py-3 rounded-2xl bg-amber-400 hover:bg-amber-500 active:scale-95 transition text-ink font-extrabold shadow-lg hidden">Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© ğŸ“</button>
              <button id="skipBtn" class="px-5 py-3 rounded-2xl bg-sky-400 hover:bg-sky-500 active:scale-95 transition text-ink font-extrabold shadow-lg">ØªØ®Ø·ÙŠ â­ï¸</button>
              <button id="resetBtn" class="px-5 py-3 rounded-2xl bg-rose-400 hover:bg-rose-500 active:scale-95 transition text-ink font-extrabold shadow-lg">Ø¥Ø¹Ø§Ø¯Ø© ğŸ”„</button>
            </div>
          </div>
        </div>

        <div class="w-full md:w-64 flex flex-col gap-4">
          <div class="rounded-2xl bg-white/20 p-4 border border-white/10">
            <div class="flex items-center justify-between">
              <span class="font-bold">Ø§Ù„Ø³Ø¬Ù„</span>
              <span class="text-sm bg-white/20 px-2 py-0.5 rounded-full">Ù†ØªØ§Ø¦Ø¬Ùƒ</span>
            </div>
            <ul id="history" class="mt-3 space-y-2 text-sm max-h-40 overflow-auto pr-1"></ul>
          </div>
        </div>
      </div>
    </section>

    <div class="mt-6 grid md:grid-cols-3 gap-4">
      <div class="rounded-2xl bg-white/15 p-4 border border-white/10">
        <div class="font-bold mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</div>
        <p class="text-white/90 text-sm">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª. Ù„Ø¯ÙŠÙƒ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.</p>
      </div>
      <div class="rounded-2xl bg-white/15 p-4 border border-white/10">
        <div class="font-bold mb-1">ØªÙ„Ù…ÙŠØ­</div>
        <p id="hintText" class="text-white/90 text-sm">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ© Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¢Ø­Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø¹Ø´Ø±Ø§Øª.</p>
      </div>
      <div class="rounded-2xl bg-white/15 p-4 border border-white/10">
        <div class="font-bold mb-1">Ø§Ù„Ù‡Ø¯Ù</div>
        <p class="text-white/90 text-sm">Ø£Ø¬Ø¨ 10 Ø£Ø³Ø¦Ù„Ø©. ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© = â­. Ø§Ø¬Ù…Ø¹ Ø£ÙƒØ«Ø± Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯Ø© Ù…Ù…ÙŠØ²Ø©!</p>
      </div>
    </div>
  </main>

  <!-- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© -->
  <section id="certificate" class="fixed inset-0 hidden items-center justify-center p-6">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-full max-w-3xl rounded-3xl bg-white text-ink shadow-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-amber-300 via-rose-300 to-sky-300 h-2"></div>
      <div class="p-6 md:p-10">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <span class="text-3xl">ğŸ†</span>
            <h2 class="text-2xl md:text-3xl font-extrabold">Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</h2>
          </div>
          <span id="gradeBadge" class="px-3 py-1 rounded-full text-sm font-bold bg-emerald-100 text-emerald-700">Ù…Ù…ØªØ§Ø²</span>
        </div>

        <div class="rounded-2xl border-4 border-dashed border-amber-300 p-6 md:p-10 text-center bg-amber-50">
          <p class="text-lg md:text-xl mb-2">Ù†Ù…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰</p>
          <div class="text-2xl md:text-4xl font-extrabold text-amber-700" id="studentName">Ø·Ø§Ù„Ø¨ Ù…Ø¬ØªÙ‡Ø¯</div>
          <p class="mt-4 text-base md:text-lg">Ù„Ø¥ÙƒÙ…Ø§Ù„Ù‡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ <span id="rightCount" class="font-bold">0</span> Ù…Ù† Ø£ØµÙ„ <span id="totalCount" class="font-bold">10</span> Ø£Ø³Ø¦Ù„Ø©.</p>
          <div class="mt-6 flex items-center justify-center gap-2 text-amber-700">
            <span>ØªØ§Ø±ÙŠØ®:</span><span id="dateStr" class="font-semibold"></span>
          </div>
        </div>

        <div class="mt-6 flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm">Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ:</label>
            <input id="nameInput" class="px-3 py-2 rounded-xl border border-slate-300 focus:ring-4 focus:ring-amber-300 outline-none" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯">
            <button id="applyName" class="px-3 py-2 rounded-xl bg-amber-400 hover:bg-amber-500 text-ink font-bold">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù…</button>
          </div>
          <div class="flex items-center gap-2">
            <button id="printBtn" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold">Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF</button>
            <button id="restartBtn" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white font-bold">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="max-w-4xl mx-auto px-6 md:px-10 pb-8 pt-2">
    <div class="rounded-2xl bg-white/10 border border-white/10 p-3 text-center text-sm">
      <div class="flex items-center justify-center gap-2">
        <img src="https://d.top4top.io/p_35209x7gh1.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù„ØªÙ‚Ù‰" class="h-8 w-8 rounded-lg object-contain bg-white/40 p-0.5"/>
        <span>Ø¨Ø±Ù…Ø¬Ø©: Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ â€” Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Â· <span class="whitespace-nowrap">Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</span></span>
      </div>
      <a href="https://t.me/ITG_KSA" class="underline text-white/90 hover:text-white mt-1 inline-block" target="_blank" rel="noopener">Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ Ø¹Ù„Ù‰ ØªÙ„ØºØ±Ø§Ù…</a>
    </div>
  </footer>

  <div class="confetti" id="confetti"></div>

  <script>
    const toEastern = (numStr)=>{
      const map = {'0':'Ù ','1':'Ù¡','2':'Ù¢','3':'Ù£','4':'Ù¤','5':'Ù¥','6':'Ù¦','7':'Ù§','8':'Ù¨','9':'Ù©','-':'âˆ’'};
      return String(numStr).split('').map(ch=> map[ch] ?? ch).join('');
    };
    const toWestern = (numStr)=>{
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','âˆ’':'-'};
      return String(numStr).split('').map(ch=> map[ch] ?? ch).join('');
    };
    const rnd = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;

    const TOTAL_QUESTIONS = 10;
    const TIME_L1 = 60;
    const TIME_L2 = 60;
    let LEVEL = 2;

    let current = 0, correct = 0, stars = 0;
    let timeLeft = TIME_L1, timerId = null;
    let a=0,b=0,sum=0;
    let A=0,B=0,SUM2=0;
    let answered = false;

    // DOM
    const qTotalEl = document.getElementById('qTotal');
    const qIndexEl = document.getElementById('qIndex');
    const progressBar = document.getElementById('progressBar');
    const timerEl = document.getElementById('timer');
    const qLabel = document.getElementById('qLabel');
    const numA = document.getElementById('numA');
    const numB = document.getElementById('numB');
    const l1wrap = document.getElementById('l1wrap');
    const l2wrap = document.getElementById('l2wrap');
    const ABox = document.getElementById('A');
    const BBox = document.getElementById('B');
    const verticalBtn = document.getElementById('verticalBtn');
    const verticalPanel = document.getElementById('verticalPanel');
    const closeVertical = document.getElementById('closeVertical');
    const tensCol = document.getElementById('tensCol');
    const onesCol = document.getElementById('onesCol');
    const verticalSteps = document.getElementById('verticalSteps');
    const feedback = document.getElementById('feedback');
    const hintBtn = document.getElementById('hintBtn');
    const skipBtn = document.getElementById('skipBtn');
    const resetBtn = document.getElementById('resetBtn');
    const starsEl = document.getElementById('stars');
    const historyEl = document.getElementById('history');
    const lvl1Btn = document.getElementById('lvl1');
    const lvl2Btn = document.getElementById('lvl2');
    const certificate = document.getElementById('certificate');
    const rightCount = document.getElementById('rightCount');
    const totalCount = document.getElementById('totalCount');
    const dateStr = document.getElementById('dateStr');
    const gradeBadge = document.getElementById('gradeBadge');
    const nameInput = document.getElementById('nameInput');
    const applyName = document.getElementById('applyName');
    const studentName = document.getElementById('studentName');
    const printBtn = document.getElementById('printBtn');
    const restartBtn = document.getElementById('restartBtn');
    const choices = document.getElementById('choices');

    function updateStars(){
      starsEl.innerHTML = '';
      for(let i=0;i<5;i++){
        const s = document.createElement('span');
        s.textContent = i < Math.min(5, stars) ? 'â­' : 'â˜†';
        s.className = 'text-xl';
        starsEl.appendChild(s);
      }
    }

    function pushHistory(text, good){
      const li = document.createElement('li');
      li.className = 'rounded-xl px-3 py-2 flex items-center justify-between bg-white/15';
      const mark = document.createElement('span');
      mark.textContent = good ? 'âœ”ï¸' : 'âŒ';
      const t = document.createElement('span');
      t.textContent = text;
      li.appendChild(t); li.appendChild(mark);
      historyEl.prepend(li);
      while(historyEl.children.length>8){ historyEl.removeChild(historyEl.lastChild); }
    }

    function setLevel(lvl){
      if(LEVEL === lvl) return;
      LEVEL = lvl;
      lvl1Btn.classList.toggle('opacity-90', LEVEL!==1);
      lvl2Btn.classList.toggle('opacity-90', LEVEL!==2);
      resetGame();
    }

    function makeDistractors(correctValue){
      const s = new Set();
      while(s.size < 3){
        let d = 0;
        if(LEVEL===1){
          const delta = [1,2,3,4,5][rnd(0,4)];
          d = Math.random()<0.5 ? correctValue+delta : correctValue-delta;
        }else{
          const A_t = Math.floor(A/10), B_t = Math.floor(B/10);
          const A_o = A%10, B_o = B%10;
          const noCarry = (A_t + B_t)*10 + ((A_o + B_o) % 10);
          const tensOnly = (A_t + B_t)*10;
          const approx = Math.floor(A/10)*10 + Math.floor(B/10)*10;
          const pool = [noCarry, tensOnly, approx, correctValue+10, correctValue-10, correctValue+1, correctValue-1];
          d = pool[rnd(0, pool.length-1)];
        }
        if(d !== correctValue && d >= 0) s.add(d);
      }
      return Array.from(s);
    }

    function renderChoices(correctValue){
      answered = false;
      choices.innerHTML = '';
      const opts = [correctValue, ...makeDistractors(correctValue)];
      // Ø´ÙÙ„
      for(let i=opts.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [opts[i],opts[j]]=[opts[j],opts[i]]; }
      opts.forEach(v=>{
        const btn = document.createElement('button');
        btn.className = 'choice px-4 py-4 rounded-2xl bg-white text-ink font-extrabold text-xl shadow hover:scale-[1.02] active:scale-95 transition border border-white/30';
        btn.dataset.val = v;
        btn.textContent = toEastern(v);
        btn.addEventListener('click', ()=> evaluateChoice(v, btn));
        choices.appendChild(btn);
      });
    }

    function newQuestion(){
      stopTimer();
      feedback.textContent = '';
      feedback.className = 'min-h-10 text-center text-lg font-semibold';
      qIndexEl.textContent = toEastern(current + 1);
      qTotalEl.textContent = toEastern(TOTAL_QUESTIONS);
      progressBar.style.width = ((current)/TOTAL_QUESTIONS*100) + '%';

      verticalPanel.classList.add('hidden');
      verticalBtn.classList.toggle('hidden', LEVEL!==2);

      if(LEVEL===1){
        l1wrap.classList.remove('hidden');
        l2wrap.classList.add('hidden');
        const range = current < 4 ? [0,9] : current < 8 ? [5,15] : [10,20];
        a = rnd(range[0], range[1]);
        b = rnd(range[0], range[1]);
        sum = a + b;
        numA.textContent = toEastern(a);
        numB.textContent = toEastern(b);
        renderChoices(sum);
        timeLeft = TIME_L1;
        timerEl.textContent = 'â±ï¸ ' + toEastern(timeLeft) + ' Ø«Ø§Ù†ÙŠØ©';
        qLabel.textContent = 'Ø³Ø¤Ø§Ù„ (Ø±Ù‚Ù… + Ø±Ù‚Ù…)';
      }else{
        l2wrap.classList.remove('hidden');
        l1wrap.classList.add('hidden');
        const rng = [10,99];
        A = rnd(rng[0], rng[1]);
        B = rnd(rng[0], rng[1]);
        SUM2 = A + B;
        ABox.textContent = toEastern(A);
        BBox.textContent = toEastern(B);
        renderChoices(SUM2);
        timeLeft = TIME_L2;
        timerEl.textContent = 'â±ï¸ ' + toEastern(timeLeft) + ' Ø«Ø§Ù†ÙŠØ©';
        qLabel.textContent = 'Ø³Ø¤Ø§Ù„ (Ø¹Ø¯Ø¯ÙŠÙ† Ù…Ù† Ø®Ø§Ù†ØªÙŠÙ†)';
      }
      startTimer();
    }

    function startTimer(){ timerEl.classList.remove('animate-pulse'); timerTick(true); timerId = setInterval(()=>timerTick(false), 1000); }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId = null; } }
    function timerTick(initial=false){
      if(!initial){ timeLeft--; }
      if(timeLeft <= 10){ timerEl.classList.add('animate-pulse'); }
      timerEl.textContent = 'â±ï¸ ' + toEastern(Math.max(0,timeLeft)) + ' Ø«Ø§Ù†ÙŠØ©';
      if(timeLeft <= 0){
        stopTimer();
        if(LEVEL===1){
          feedback.textContent = `Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ ${toEastern(sum)}`;
          pushHistory(`${toEastern(a)} + ${toEastern(b)} = ${toEastern(sum)}`, false);
        }else{
          feedback.textContent = `Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ ${toEastern(A)} + ${toEastern(B)} = ${toEastern(SUM2)}`;
          pushHistory(`${toEastern(A)} + ${toEastern(B)} = ${toEastern(SUM2)}`, false);
        }
        feedback.classList.add('text-rose-100');
        disableChoices();
        nextStep();
      }
    }
    function disableChoices(){ choices.querySelectorAll('button').forEach(b=> b.disabled = true); }

    function evaluateChoice(val, btn){
      if(answered) return;
      answered = true;
      stopTimer();
      let good = false, correctValue = 0, expr = '';
      if(LEVEL===1){
        correctValue = sum; good = (val === sum); expr = `${toEastern(a)} + ${toEastern(b)} = ${toEastern(val)}`;
      }else{
        correctValue = SUM2; good = (val === SUM2); expr = `${toEastern(A)} + ${toEastern(B)} = ${toEastern(val)}`;
      }
      if(good){
        correct++; stars++; feedback.textContent = 'Ø£Ø­Ø³Ù†Øª! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ğŸ‰'; feedback.classList.add('text-emerald-100');
        btn.classList.remove('bg-white'); btn.classList.add('bg-emerald-300'); pushHistory(expr, true);
      }else{
        feedback.textContent = `Ù‚Ø±ÙŠØ¨! Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ ${toEastern(correctValue)}`; feedback.classList.add('text-rose-100');
        btn.classList.remove('bg-white'); btn.classList.add('bg-rose-300');
        const rightBtn = Array.from(choices.children).find(b=> +b.dataset.val===correctValue);
        if(rightBtn){ rightBtn.classList.remove('bg-white'); rightBtn.classList.add('bg-emerald-200'); }
        pushHistory(`${expr} â‰  ${toEastern(correctValue)}`, false);
      }
      disableChoices(); updateStars(); nextStep();
    }

    function nextStep(){
      current++; progressBar.style.width = ((current)/TOTAL_QUESTIONS*100) + '%';
      if(current >= TOTAL_QUESTIONS){ endGame(); } else { setTimeout(newQuestion, 900); }
    }

    function fireConfetti(count){
      const layer = document.getElementById('confetti'); layer.innerHTML = '';
      const colors = ['#fbbf24','#38bdf8','#a78bfa','#34d399','#f472b6','#f87171'];
      for(let i=0;i<count;i++){
        const p = document.createElement('div'); p.className = 'p'; p.style.left = Math.random()*100 + 'vw';
        p.style.background = colors[i%colors.length]; p.style.animationDuration = (8 + Math.random()*6) + 's';
        p.style.animationDelay = (Math.random()*2) + 's'; p.style.transform = `rotate(${Math.random()*360}deg)`;
        layer.appendChild(p);
      }
      setTimeout(()=>{ layer.innerHTML=''; }, 15000);
    }

    function endGame(){
      rightCount.textContent = toEastern(correct);
      totalCount.textContent = toEastern(TOTAL_QUESTIONS);
      const d = new Date();
      try{ dateStr.textContent = d.toLocaleDateString('ar-EG', { year:'numeric', month:'long', day:'numeric' }); }
      catch(_){ dateStr.textContent = d.toISOString().slice(0,10); }
      const rate = correct / TOTAL_QUESTIONS;
      if(rate >= .9){ gradeBadge.textContent = 'Ù…Ù…ØªØ§Ø²'; gradeBadge.className='px-3 py-1 rounded-full text-sm font-bold bg-emerald-100 text-emerald-700';}
      else if(rate >= .7){ gradeBadge.textContent = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'; gradeBadge.className='px-3 py-1 rounded-full text-sm font-bold bg-sky-100 text-sky-700';}
      else if(rate >= .5){ gradeBadge.textContent = 'Ø¬ÙŠØ¯'; gradeBadge.className='px-3 py-1 rounded-full text-sm font-bold bg-amber-100 text-amber-700';}
      else { gradeBadge.textContent = 'Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨'; gradeBadge.className='px-3 py-1 rounded-full text-sm font-bold bg-rose-100 text-rose-700';}
      fireConfetti(80); certificate.classList.remove('hidden'); certificate.classList.add('flex');
    }

    function resetGame(){
      stopTimer(); current = 0; correct = 0; stars = 0; historyEl.innerHTML=''; updateStars();
      progressBar.style.width = '0%'; qIndexEl.textContent = toEastern(0); feedback.textContent = '';
      const t = LEVEL===1 ? TIME_L1 : TIME_L2; timerEl.textContent = 'â±ï¸ ' + toEastern(t) + ' Ø«Ø§Ù†ÙŠØ©';
      certificate.classList.add('hidden'); certificate.classList.remove('flex'); newQuestion();
    }

    // ØªÙ„Ù…ÙŠØ­ + Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª
    hintBtn.addEventListener('click', ()=>{
      feedback.innerHTML = '';
      const wrap = document.createElement('div'); wrap.className = 'mt-3 text-center';
      if(LEVEL===1){
        const line = document.createElement('div');
        line.className = 'inline-flex items-center gap-2 bg-white/15 rounded-2xl px-4 py-2';
        line.innerHTML = `Ù‚Ø³Ù‘Ù…Ù‡Ø§ Ø¥Ù„Ù‰ Ù†Ù‚Ø§Ø·: <span class="text-amber-200 font-extrabold">${toEastern(a)}</span> + <span class="text-sky-200 font-extrabold">${toEastern(b)}</span>`;
        wrap.appendChild(line);
      }else{
        const tens = Math.floor(A/10)*10 + Math.floor(B/10)*10; const ones = (A%10) + (B%10); const carry = ones >= 10 ? 1 : 0;
        const hint = document.createElement('div'); hint.className = 'space-y-2';
        hint.innerHTML = `
          <div class="inline-flex items-center gap-2 bg-white/15 rounded-2xl px-4 py-2">
            Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø´Ø±Ø§Øª: <span class="font-extrabold text-amber-200">${toEastern(Math.floor(A/10)*10)}</span> +
            <span class="font-extrabold text-rose-200">${toEastern(Math.floor(B/10)*10)}</span> =
            <span class="font-extrabold">${toEastern(tens)}</span>
          </div>
          <div class="inline-flex items-center gap-2 bg-white/15 rounded-2xl px-4 py-2">
            ÙˆØ§Ø¬Ù…Ø¹ Ø§Ù„Ø¢Ø­Ø§Ø¯: <span class="font-extrabold text-amber-200">${toEastern(A%10)}</span> +
            <span class="font-extrabold text-rose-200">${toEastern(B%10)}</span> =
            <span class="font-extrabold">${toEastern(ones)}</span> ${carry? '(Ù…Ø¹ Ù†Ù‚Ù„ Ù¡)': ''}
          </div>
          <div class="inline-flex items-center gap-2 bg-white/15 rounded-2xl px-4 py-2">
            Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span class="font-extrabold">${toEastern(A)} + ${toEastern(B)} = ${toEastern(SUM2)}</span>
          </div>`;
        wrap.appendChild(hint);
      }
      feedback.appendChild(wrap);
    });

    verticalBtn.addEventListener('click', ()=>{ verticalPanel.classList.remove('hidden'); buildVertical(); });

    function buildVertical(){
      // ØªÙ†Ø¸ÙŠÙ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
      tensCol.innerHTML = ''; onesCol.innerHTML = ''; verticalSteps.innerHTML = '';

      const A_t = Math.floor(A/10), A_o = A%10;
      const B_t = Math.floor(B/10), B_o = B%10;

      const row = (c)=>{ const d=document.createElement('div'); d.className='h-10 md:h-12 flex items-center justify-center'; d.innerHTML=c; return d; };

      // Ù„Ø§ Ù†ÙƒØ±Ø± Ø¹Ù†Ø§ÙˆÙŠÙ† "Ø§Ù„Ø¢Ø­Ø§Ø¯/Ø§Ù„Ø¹Ø´Ø±Ø§Øª" Ù‡Ù†Ø§ â€” Ù‡ÙŠ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙˆÙ‚ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
      // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„
      tensCol.appendChild(row(`<span>${toEastern(A_t)}</span>`));
      onesCol.appendChild(row(`<span>${toEastern(A_o)}</span>`));

      // Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¬Ù…Ø¹
      tensCol.appendChild(row(`<span class="text-white/70">+</span>`));
      onesCol.appendChild(row(`<span class="text-white/70">+</span>`));

      // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ
      tensCol.appendChild(row(`<span>${toEastern(B_t)}</span>`));
      onesCol.appendChild(row(`<span>${toEastern(B_o)}</span>`));

      // Ø®Ø· ÙØ§ØµÙÙ„
      tensCol.appendChild(row(`<span class="block w-10 h-0.5 bg-white/50 rounded-full"></span>`));
      onesCol.appendChild(row(`<span class="block w-10 h-0.5 bg-white/50 rounded-full"></span>`));

      // Ø§Ù„Ù†Ø§ØªØ¬
      const onesSum = A_o + B_o;
      const carry = onesSum >= 10 ? 1 : 0;
      const onesRes = onesSum % 10;
      const tensRes = A_t + B_t + carry;

      tensCol.appendChild(row(`<span class="text-emerald-200">${toEastern(tensRes)}</span>`));
      onesCol.appendChild(row(`<span class="text-emerald-200">${toEastern(onesRes)}</span>`));

      // Ø®Ø·ÙˆØ§Øª Ù„ÙØ¸ÙŠØ©
      const steps = [];
      steps.push(`Ù¡) Ø§Ù„Ø¢Ø­Ø§Ø¯: ${toEastern(A_o)} + ${toEastern(B_o)} = ${toEastern(onesSum)} ${carry? 'â† Ù†Ù†Ù‚Ù„ Ù¡ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø´Ø±Ø§Øª':''}`);
      steps.push(`Ù¢) Ø§Ù„Ø¹Ø´Ø±Ø§Øª: ${toEastern(A_t)} + ${toEastern(B_t)} ${carry? '+ Ù¡':''} = ${toEastern(tensRes)}`);
      steps.push(`Ù£) Ø§Ù„Ù†Ø§ØªØ¬: ${toEastern(A)} + ${toEastern(B)} = ${toEastern(SUM2)}`);
      verticalSteps.innerHTML = steps.map(s=> `<div class="rounded-lg bg-white/10 px-3 py-2">${s}</div>`).join('');
    }

    closeVertical.addEventListener('click', ()=> verticalPanel.classList.add('hidden'));

    // Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
    document.getElementById('skipBtn').addEventListener('click', ()=>{
      stopTimer();
      if(LEVEL===1){ pushHistory(`${toEastern(a)} + ${toEastern(b)} (ØªØ®Ø·ÙŠ) = ${toEastern(sum)}`, false); feedback.textContent = `ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ. Ø§Ù„ØµØ­ÙŠØ­: ${toEastern(sum)}`; }
      else { pushHistory(`${toEastern(A)} + ${toEastern(B)} (ØªØ®Ø·ÙŠ) = ${toEastern(SUM2)}`, false); feedback.textContent = `ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ. Ø§Ù„ØµØ­ÙŠØ­: ${toEastern(SUM2)}`; }
      feedback.classList.add('text-white'); disableChoices(); nextStep();
    });
    resetBtn.addEventListener('click', resetGame);
    lvl1Btn.addEventListener('click', ()=> setLevel(1));
    lvl2Btn.addEventListener('click', ()=> setLevel(2));
    applyName.addEventListener('click', ()=>{ const n = nameInput.value.trim(); if(n.length>0){ studentName.textContent = n; } });
    printBtn.addEventListener('click', ()=> window.print());
    restartBtn.addEventListener('click', ()=> { certificate.classList.add('hidden'); certificate.classList.remove('flex'); resetGame(); });

    // Ø¨Ø¯Ø¡
    updateStars(); newQuestion();
  </script>
</body>
</html>
